workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_TAG'
    - when: never

stages:
  - validate
  - lint
  - build
  - test
  - scan
  - deploy
  - notify

variables:
  DOCKER_IMAGE: rogerramossilva/myapp

validate-compose:
  stage: validate
  script:
    - docker compose config
  rules:
    - exists:
        - docker-compose.yml
    - if: '$CI_COMMIT_BRANCH == "main"'

lint-php:
  stage: lint
  script:
    - find src/ -name "*.php" -exec php -l {} \;
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'

run-tests:
  stage: test
  script:
    - php tests/test.php
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

build-image:
  stage: build
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'

security-scan:
  stage: scan
  script:
    - docker pull $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA || true
    - trivy image --format json --output trivy-report.json $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA || true
  artifacts:
    name: "trivy-report"
    paths:
      - trivy-report.json
    when: always
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

push-staging:
  stage: deploy
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - docker tag $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE:staging
    - docker push $DOCKER_IMAGE:staging
  environment:
    name: staging
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'

push-production:
  stage: deploy
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - docker tag $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:latest
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_TAG'

notify:
  stage: notify
  script:
    - |
      curl -X POST -H 'Content-type: application/json' --data "{
        \"text\": \"âœ… *Pipeline finalizada* em \`$CI_COMMIT_BRANCH\` para *$CI_PROJECT_NAME* - Commit \`$CI_COMMIT_SHORT_SHA\`\nðŸ”— <$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID|Ver pipeline>\"
      }" $SLACK_WEBHOOK_URL
  rules:
    - when: always
